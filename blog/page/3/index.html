
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Daniel Cadenas</title>
  <meta name="author" content="Daniel Cadenas">

  
  <meta name="description" content="As far as google told me, it seems you can&#8217;t use Mocha against constants. One alternative proposed is changing the constant in the test where &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://dcadenas.github.com/blog/page/3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Daniel Cadenas" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1886130-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Daniel Cadenas</a></h1>
  
    <h2>My technical blog.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:dcadenas.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/09/10/stubbingmocking-constants-with-mocha/">Stubbing/Mocking Constants With Mocha</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-10T12:34:00-03:00" pubdate data-updated="true">Sep 10<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As far as google told me, it seems you can&#8217;t use Mocha against constants.</p>

<p>One alternative <a href="http://rubyforge.org/pipermail/mocha-developer/2007-July/000394.html">proposed</a> is changing the constant in the test where you need it like these:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Module</span>
</span><span class='line'>   <span class="k">def</span> <span class="nf">redefine_const</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>     <span class="nb">__send__</span><span class="p">(</span><span class="ss">:remove_const</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span> <span class="k">if</span> <span class="nb">const_defined?</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>     <span class="nb">const_set</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And inside the test case you change the constant to what you need and restore it after the test ends:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Object</span><span class="o">.</span><span class="n">redefine_const</span><span class="p">(</span><span class="ss">:RAILS_ENV</span><span class="p">,</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>But if you can control the code that uses the constant there&#8217;s a more clean way. Just wrap it in a method and get the constant through the method. During testing you just mock the method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">A</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">rails_env</span>
</span><span class='line'>    <span class="no">RAILS_ENV</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1">#...some more code that gets the constant RAILS_ENV using the method rails_env...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And then in your test you just do a normal expectation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">A</span><span class="o">.</span><span class="n">any_instance</span><span class="o">.</span><span class="n">expects</span><span class="p">(</span><span class="ss">:rails_env</span><span class="p">)</span><span class="o">.</span><span class="n">returns</span> <span class="s1">&#39;production&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>You could even have some module that wraps all useful constants in your app, so constant dependent code gets easily testable and clean.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/09/03/singleton-class-magic-without-using/">Singleton Class Magic Without Using Singleton Classes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-09-03T11:25:00-03:00" pubdate data-updated="true">Sep 3<span>rd</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Excellent posts <a href="http://blog.jayfields.com/2008/04/extend-modules-instead-of-defining.html">here</a> and <a href="http://blog.jayfields.com/2008/07/ruby-underuse-of-modules.html">here</a> by Jay Fields where he gives an alternative to use singleton classes.</p>

<p>Instead of doing this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">hi</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s1">&#39;Hi&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>he proposes to do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">mod</span> <span class="o">=</span> <span class="no">Module</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">hi</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s1">&#39;Hi&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="kp">extend</span> <span class="n">mod</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/08/25/reverse-ajax-and-prototype/">Reverse Ajax and Prototype With Mongrel Handlers</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-25T23:38:00-03:00" pubdate data-updated="true">Aug 25<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A common use of <a href="http://en.wikipedia.org/wiki/Reverse_Ajax">reverse Ajax or Comet</a> calls is having some piece of information in your webpage that you want to update as soon as some remote event triggers, always without polling. Let&#8217;s make a little experiment to see how this works:</p>

<h2>Client side</h2>

<p>So you start a request, the web server waits for the event to happen, and finally, a while later, the response is sent back to the client. When this process ends, it&#8217;s very common that you want to start it again. You want to have a continuous ajax call when the event is also continuous, when it can happen many times.
To deal with this, as I&#8217;m using <a href="http://www.prototypejs.org/">prototype</a>, I made this javascript routine to start listening for the event:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">continuousAjaxCall</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">successCallback</span><span class="p">){</span>
</span><span class='line'>  <span class="nx">waitingForResponse</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">iteration</span><span class="p">(){</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">waitingForResponse</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">waitingForResponse</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>      <span class="k">new</span> <span class="nx">Ajax</span><span class="p">.</span><span class="nx">Request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>         <span class="nx">method</span><span class="o">:</span> <span class="nx">method</span><span class="p">,</span>
</span><span class='line'>         <span class="nx">parameters</span><span class="o">:</span> <span class="nx">params</span><span class="p">,</span>
</span><span class='line'>         <span class="nx">onSuccess</span><span class="o">:</span> <span class="nx">theSuccessCallback</span>
</span><span class='line'>       <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">theSuccessCallback</span><span class="p">(</span><span class="nx">transport</span><span class="p">){</span>
</span><span class='line'>   <span class="nx">successCallback</span><span class="p">(</span><span class="nx">transport</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
</span><span class='line'>   <span class="nx">waitingForResponse</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nx">PeriodicalExecuter</span><span class="p">(</span><span class="nx">iteration</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So now if you do:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">continuousAjaxCall</span><span class="p">(</span><span class="s2">&quot;/WebFacade/SomeWebService&quot;</span><span class="p">,</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="s2">&quot;taskid=&quot;</span> <span class="o">+</span> <span class="nx">taskNumber</span><span class="p">,</span> <span class="nx">callback</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>you will start listening to the web service in <code>/WebFacade/SomeWebService</code> using method post and with <code>taskid=taskNumber</code> as the http body parameter.
The callback is a routine that will be executed each time the event is triggered. For example we could do this to show the result from the web service:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">responseText</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nx">alert</span><span class="p">(</span><span class="nx">responseText</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The routine returns a prototype <a href="http://www.prototypejs.org/api/periodicalExecuter"><code>PeriodicalExecuter</code></a> that you can use to stop listening:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">pe</span> <span class="o">=</span> <span class="nx">continuousAjaxCall</span><span class="p">(...</span>
</span><span class='line'><span class="nx">pe</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Server side</h2>

<p>In the server side I have some <a href="/blog/2008/08/24/standalone-mongrel-handler-hello-world">Mongrel handlers</a> serving the client pages. The key here is the line sleep 1 until <code>@@submitted_value</code> that waits until some new value is submitted and <strong>only</strong> then responds to the ajax request:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;mongrel&#39;</span>
</span><span class='line'><span class="kp">include</span> <span class="no">Mongrel</span>
</span><span class='line'>
</span><span class='line'><span class="vc">@@submitted_value</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ReverseAjaxHandler</span> <span class="o">&lt;</span> <span class="no">HttpHandler</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</span><span class='line'>    <span class="n">response</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">head</span><span class="p">,</span><span class="n">out</span><span class="o">|</span>
</span><span class='line'>      <span class="n">head</span><span class="o">[</span><span class="s1">&#39;content-type&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;text/html&#39;</span>
</span><span class='line'>      <span class="nb">sleep</span> <span class="mi">1</span> <span class="k">until</span> <span class="vc">@@submitted_value</span>
</span><span class='line'>      <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="vc">@@submitted_value</span>
</span><span class='line'>      <span class="vc">@@submitted_value</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">SendHandler</span> <span class="o">&lt;</span> <span class="no">HttpHandler</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</span><span class='line'>    <span class="n">response</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">head</span><span class="p">,</span><span class="n">out</span><span class="o">|</span>
</span><span class='line'>      <span class="c1">#Code that renders the &quot;/send&quot; page and sets the @@submitted_value</span>
</span><span class='line'>      <span class="c1">#...  </span>
</span><span class='line'>      <span class="c1">#...  </span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">h</span> <span class="o">=</span> <span class="no">HttpServer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;5000&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;/wait&quot;</span><span class="p">,</span> <span class="no">ReverseAjaxHandler</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;/send&quot;</span><span class="p">,</span> <span class="no">SendHandler</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;/files&quot;</span><span class="p">,</span> <span class="no">DirHandler</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span>
</span><span class='line'><span class="n">h</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">join</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s nice to have this as a Mongrel handler because it&#8217;s simple, but keep in mind that this implementation was made just for the purpose of this example and it is not thread safe. I don&#8217;t control the access to the global variable <code>@@submitted_value</code>.</p>

<p>The code for this article can be found <a href="http://dcadenas.googlepages.com/ReverseAjaxExperiment.zip">here</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/08/24/standalone-mongrel-handler-hello-world/">Standalone Mongrel Handler Hello World</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-08-24T14:00:00-03:00" pubdate data-updated="true">Aug 24<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I think this is the simplest Mongrel handler you can create. It doesn&#8217;t depend on Rails so this is not what you need to write if you want to install a Rails friendly Mongrel handler.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;mongrel&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">HelloHandler</span> <span class="o">&lt;</span> <span class="no">Mongrel</span><span class="o">::</span><span class="no">HttpHandler</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</span><span class='line'>    <span class="n">response</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">head</span><span class="p">,</span><span class="n">out</span><span class="o">|</span>
</span><span class='line'>      <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;Hello World!&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>h = Mongrel::HttpServer.new(&#8220;0.0.0.0&#8221;, &#8220;5000&#8221;)
h.register(&#8220;/hello&#8221;, HelloHandler.new)
h.run.join</p>

<p><strong>Notes:</strong> If you want to output html remember to <code>include head['content-type'] = 'text/html'</code> inside the inner block.
To include static pages you can add <code>h.register("/files", DirHandler.new('.'))</code>. After this you can access all files in the current directory through <code>http://localhost:5000/files</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/03/13/dependency-graphs-gem/">A Dependency Graphs Gem</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-03-13T01:06:00-03:00" pubdate data-updated="true">Mar 13<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Some days ago I had to do a big refactoring involving almost 100 C# projects, a little monster. I thought it would be very helpful to have a dependency graph that could quickly show me the projects dependencies I was interested in at any given moment and that would let me apply some filters to the result.
I didn&#8217;t like the few things I found in the net so I did a Ruby program to traverse csproj files and generate a <a href="http://www.graphviz.org/">Graphviz</a> graph with the desired results, something like this:</p>

<p><img class="center" src="http://depgraph.rubyforge.org/image1.png"></p>

<p>So as I thought this could be useful to a lot of people I decided to make it open source so I created <a href="http://depgraph.rubyforge.org">this Rubyforge project</a> to host it.</p>

<p>I made some changes to make it generic so that it could be used for any kind of text files that have parseable dependencies hidden inside.
There are 2 examples stored in a yaml configuration file that deal with C# projects and Ruby <code>requires</code> statements.</p>

<p>So for example, if you want to graph your C# projects you do this from the root directory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>depgraph -type csproj
</span></code></pre></td></tr></table></div></figure>


<p>And if you want to graph the requires dependencies of your Ruby files you do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>depgraph -type ruby_requires
</span></code></pre></td></tr></table></div></figure>


<p>Then if you add a new entry in the yaml configuration file you&#8217;ll be able to do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>depgraph -type <span class="o">[</span>new entry name<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can also filter by directories and node name regular expressions against source and dependency targets. I&#8217;ll add more functionality in next releases but it&#8217;s already usable.</p>

<p>To install it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem install DepGraph
</span></code></pre></td></tr></table></div></figure>


<p>As always, check the <a href="http://depgraph.rubyforge.org/">project&#8217;s webpage</a> and the <a href="http://depgraph.rubyforge.org/specs.html">specs</a> for more info.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2008/03/04/file-system-integration-tests-helper/">A File System Integration Tests Helper</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2008-03-04T20:50:00-02:00" pubdate data-updated="true">Mar 4<span>th</span>, 2008</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A common problem that arises when creating integration tests against the file system is not having a one on one mapping between test cases and file structures.</p>

<p>The most popular solution is having one generic file structure defined outside the test case (manually or in the test fixture set up) in which a generic set of files are shared among many different test cases.</p>

<p>This works, but the problem is that we lose a lot of the documenting benefit of tests.</p>

<p>The expressive power we could gain by the explicit creation of customized test files for each test case is very important.</p>

<p>Of course we should test all we can inside our unit tests but it&#8217;s always good to have something in our toolbox in case we have to go to the real thing at some moment.</p>

<p>One example is when you have to deal with highly coupled legacy code in which your only practical solution may be testing directly against it&#8217;s file inputs and outputs.</p>

<p>So considering all this I made a very simple ruby gem, <a href="http://filetesthelper.rubyforge.org/">filetesthelper</a>, that let&#8217;s you do something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;file_test_helper&#39;</span>
</span><span class='line'><span class="kp">include</span> <span class="no">FileTestHelper</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">test_some_code_that_uses_the_file_system</span>
</span><span class='line'>  <span class="c1">#Let&#39;s say that the current directory here is X</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">with_files</span><span class="p">(</span><span class="s1">&#39;dir1/file1&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;file1 content&#39;</span><span class="p">,</span> <span class="s1">&#39;file2&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;file2 content&#39;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1">#Now the current directory changed to Y which is a new directory created under Dir.tmpdir containing only &#39;dir1/file1&#39; and &#39;file2&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;file2&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>      <span class="c1">#All filesystem operations are now scoped to the test directory</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#When we finish we are back at directory X and the Y directory </span>
</span><span class='line'>  <span class="c1">#is deleted with all its contents</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Check the <a href="http://filetesthelper.rubyforge.org/specs.html">specs</a> for some more details.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/12/08/more-about-refactoring/">More About Refactoring</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-12-08T19:09:00-02:00" pubdate data-updated="true">Dec 8<span>th</span>, 2007</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Some points of disagreement with the critique against the <a href="http://www.amazon.com/Refactoring-Improving-Existing-Addison-Wesley-Technology/dp/0201485672">refactoring book</a> found in <a href="http://www.codinghorror.com/blog/archives/000589.html">this article about smells</a>.</p>

<ul>
<li><p>Assuming that he is right in that most of us know how to refactor, I think that&#8217;s because experience gave us the needed knowledge. Time and pain was needed. This time and pain, as in any knowledge area, can be reduced by reading books, like Fowler&#8217;s.</p></li>
<li><p>Apart from this, I think even a developer with experience and knowledge of most refactorings could miss some smells. We are humans and we acquire bad habits.</p></li>
<li><p>A big part of the knowledge gained with experience is too intuitive and that brings some problems. When things are intuitive and you suddenly find someone that doesn&#8217;t share your intuition you have to discuss with solid explicit arguments. Fowler&#8217;s book helps you ease the work needed to find those arguments letting you show clearly why your intuition is the way it is. You can do it yourself of course, but it&#8217;s easier to reuse the effort someone else did, if you share it of course.</p></li>
<li><p>The book defines a vocabulary to deal with our intuition or implicit concepts, that is very very important. Now we can share it and we can communicate more efficiently. The same advantage we discovered after design patterns appeared.</p></li>
<li><p>He agrees with Fowler that smells are important. The book is a reference to smells. IMO refactoring is more about identifying design problems (smells) than about the relatively simple things needed to make them disappear, but it&#8217;s both.</p></li>
<li><p>Things that are important, like smells, must be made explicit so the problem can be easily studied and possibly build some more knowledge on higher level concepts. One of those higher level concepts that could be further developed was the development philosophy of <a href="http://martinfowler.com/ieeeSoftware/continuousDesign.pdf">Continuous Design</a> in which a core concept is refactoring.</p></li>
<li><p>I think there&#8217;s a confusion between simplicity and importance. Not only complicated books are important.</p></li>
</ul>


<p>Seems that a big reason for this disagreement comes from not seeing a tight relationship between code smells and refactoring as explained in <a href="/blog/2007/12/03/meaning-of-refactoring">this previous post</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/12/04/more-about-architects/">More About Architects</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-12-04T23:31:00-02:00" pubdate data-updated="true">Dec 4<span>th</span>, 2007</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I found <a href="http://martinfowler.com/ieeeSoftware/whoNeedsArchitect.pdf">this</a> great Fowler&#8217;s article which I think compliments well with my <a href="/blog/2007/11/09/architects-and-programmers">previous post</a> saying that architects are programmers.</p>

<p>Then I found <a href="http://martinfowler.com/articles/designDead.html">this</a> other great webpage he wrote about software design.</p>

<p>In the paragraph <em>Do you wanna be an Architect when you grow up?</em> he talks about this issue. I think that the <em>I&#8217;m not just a mere programmer - I&#8217;m an architect</em> feeling he points out is one of the reasons people feel so much against this natural unification of responsibilities.</p>

<p>Just imagine a football team in which only forwards are supposed to score goals and discouraged to assist and midfielders can only assist but are discouraged to score goals, it would be just stupid the way resources would be wasted with this separation.</p>

<p>Now imagine a software system in which only the architect takes architecture decisions and doesn&#8217;t touch code, and programmers only code and don&#8217;t take architecture decisions. It is unnatural.</p>

<p>Wouldn&#8217;t be better if all players, err, programmers could make that decision as a team? You would just listen more carefully to the experienced programmer that is the architect and you&#8217;d have to be more trained on design. But that has always been your responsibility, you develop software! A programmer without design knowledge (or will to improve it) is like a football player that can&#8217;t make a decent pass.</p>

<p>Finally it seems Jeremy D. Miller also agrees on this as he shows in another <a href="http://codebetter.com/blogs/jeremy.miller/archive/2007/10/03/strength-at-the-point-of-attack.aspx">post</a>.</p>

<p>So I got quite happy to discover so many people think the same way. I guess this <em>architects are developers</em> belief is more popular than I thought and that can only be good!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/12/03/meaning-of-refactoring/">The Meaning of Refactoring</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-12-03T02:21:00-02:00" pubdate data-updated="true">Dec 3<span>rd</span>, 2007</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>For a lot of people refactoring is not important. For some people this is because they don&#8217;t know the correct meaning. They think it&#8217;s just the name someone made up to describe any code change.</p>

<p>That&#8217;s not refactoring.</p>

<p>You refactor when the changes you make <strong>improve</strong> the design while keeping its behaviour unchanged. Knowing <a href="http://martinfowler.com/bliki/CodeSmell.html">when</a> and <a href="http://www.amazon.com/Refactoring-Improving-Existing-Addison-Wesley-Technology/dp/0201485672">how</a> this improvement should be systematically made is what is taught in the literature.</p>

<p>But there&#8217;s another group of people that know the correct definition but still don&#8217;t believe in it. This is because they measure their design quality just by its behaviour, so if the code already does what it&#8217;s intended to do, they think it&#8217;s good code. They believe in the <em>Don&#8217;t touch the design if it&#8217;s not broken</em> mantra (a slightly more valid reason to believe in this comes from lacking a good set of tests that act as a safety net for your design improvements).</p>

<p>For this reason they slowly start accumulating <a href="http://c2.com/cgi/wiki?DesignDebt">design debt</a>. At some point, not too far in time, this unattended design improvement brings the impossibility to change code as it can&#8217;t be controlled. This is because it&#8217;s too difficult to understand and see all consequences of any change they may do, so either they don&#8217;t change code anymore, or if they do, they start seeing bugs appear everywhere because they broke something they couldn&#8217;t see it could get broken. So they say <em>You see? I was right, code shouldn&#8217;t be changed if it&#8217;s not broken</em>, a self-fulfilling prophecy.</p>

<p>So in summary, refactoring requires the ability to systematically <a href="http://martinfowler.com/bliki/CodeSmell.html">identify</a> and improve problematic designs and it&#8217;s important because it pays your design debt. This is necessary to understand and change your code easily.</p>

<p>This are great books you can read to improve refactoring skills:</p>

<ul>
<li><a href="http://www.amazon.com/Refactoring-Improving-Existing-Addison-Wesley-Technology/dp/0201485672">Refactoring: Improving the Design of Existing Code</a></li>
<li><a href="http://www.amazon.com/Refactoring-Patterns-Addison-Wesley-Signature-Kerievsky/dp/0321213351">Refactoring to Patterns</a></li>
<li><a href="http://www.amazon.com/xUnit-Test-Patterns-Refactoring-Addison-Wesley/dp/0131495054">xUnit Test Patterns: Refactoring Test Code</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2007/11/13/escaping/">Escaping CDATA</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2007-11-13T23:13:00-02:00" pubdate data-updated="true">Nov 13<span>th</span>, 2007</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a handy code that wraps a string with CDATA escaping any CDATA inside it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c#'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">CData</span><span class="p">(</span><span class="kt">string</span> <span class="n">data</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">Regex</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;]]&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;]]]]&gt;&lt;![CDATA[&gt;&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;&lt;![CDATA[&quot;</span> <span class="p">+</span> <span class="n">result</span> <span class="p">+</span> <span class="s">&quot;]]&gt;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/03/16/moving-to-github-pages-and-octopress/">Moved to github pages and Octopress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/18/updating-go-to-edge/">Updating go to edge</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/10/11/cors-with-extjs/">CORS with Ext.js</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/09/10/download-file-from-megaupload-with-curl/">Download a file from Wupload or Filesonic with curl</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/03/09/valgrind-on-your-ruby-extension-test/">Valgrind on your ruby extension test</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/dcadenas">@dcadenas</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'dcadenas',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("dcadenas", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/dcadenas" class="twitter-follow-button" data-show-count="false">Follow @dcadenas</a>
  
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Daniel Cadenas -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mytechnicalblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
